import 'dart:math';
import 'package:flutter/material.dart';
import 'package:audioplayers/audioplayers.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'ä¹˜æ³•ç·´ç¿’',
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: Colors.blue,
      ),
      home: const MultiplicationPracticePage(),
    );
  }
}

class MultiplicationPracticePage extends StatefulWidget {
  const MultiplicationPracticePage({super.key});

  @override
  State<MultiplicationPracticePage> createState() =>
      _MultiplicationPracticePageState();
}

class _MultiplicationPracticePageState
    extends State<MultiplicationPracticePage> {
  final Random _random = Random();
  final TextEditingController _answerController = TextEditingController();
  final FocusNode _answerFocus = FocusNode();

  late int _a;
  late int _b;
  String _message = '';
  Color _messageColor = Colors.black;

  // éŸ³æ•ˆæ’­æ”¾å™¨
  final AudioPlayer _player = AudioPlayer();

  // è¨­å®šï¼šä½æ•¸ï¼ˆé è¨­ 1 ä½æ•¸ Ã— 1 ä½æ•¸ï¼‰
  int _digitsA = 1; // ç¬¬ä¸€å€‹æ•¸å­—çš„ä½æ•¸ï¼š1~9
  int _digitsB = 1; // ç¬¬äºŒå€‹æ•¸å­—çš„ä½æ•¸ï¼š1~9

  // æ˜¯å¦åœ¨è¨­å®šé 
  bool _inSettings = true;

  @override
  void initState() {
    super.initState();
    // ä¸€é–‹å§‹å…ˆé¡¯ç¤ºè¨­å®šé 
  }

  @override
  void dispose() {
    _answerController.dispose();
    _answerFocus.dispose();
    _player.dispose();
    super.dispose();
  }

  /// ä¾ç…§ä½æ•¸ç”¢ç”Ÿäº‚æ•¸
  int _randomNumberWithDigits(int digits) {
    // 1 ä½æ•¸æ²¿ç”¨ä½ åŸæœ¬çš„ 2~9
    if (digits <= 1) {
      return 2 + _random.nextInt(8); // 2~9
    }

    // 2 ä½æ•¸ï¼š10~99ï¼Œ3 ä½æ•¸ï¼š100~999 ... ç›´åˆ° 9 ä½æ•¸
    final int min = pow(10, digits - 1).toInt();
    final int max = pow(10, digits).toInt() - 1;
    return min + _random.nextInt(max - min + 1);
  }

  void _generateNewQuestion() {
    setState(() {
      _a = _randomNumberWithDigits(_digitsA);
      _b = _randomNumberWithDigits(_digitsB);
      _answerController.clear();
      _message = '';
    });
  }

  Future<void> _checkAnswer() async {
    final text = _answerController.text.trim();
    if (text.isEmpty) {
      setState(() {
        _message = 'è«‹å…ˆè¼¸å…¥ç­”æ¡ˆ';
        _messageColor = Colors.orange;
      });
      return;
    }

    final int? value = int.tryParse(text);
    if (value == null) {
      setState(() {
        _message = 'è«‹è¼¸å…¥æ•´æ•¸å–”';
        _messageColor = Colors.orange;
      });
      return;
    }

    final correct = _a * _b;
    if (value == correct) {
      setState(() {
        _message = 'ç­”å°äº†ï¼å¤ªæ£’äº† ğŸ‰';
        _messageColor = Colors.green;
      });

      // æ’­æ”¾ç­”å°éŸ³æ•ˆ (ding.mp3)
      try {
        await _player.play(
          AssetSource('sounds/ding.mp3'),
        );
      } catch (e) {
        debugPrint('æ’­æ”¾éŸ³æ•ˆéŒ¯èª¤: $e');
      }

      // æ›ä¸‹ä¸€é¡Œ
      await Future.delayed(const Duration(milliseconds: 600));
      _generateNewQuestion();
      _requestFocus();
    } else {
      setState(() {
        // é€™è£¡ä¾ä½ çš„è¦æ±‚ï¼šä¸è¦é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        _message = 'ç­”éŒ¯äº†ï¼Œå†è©¦è©¦ ğŸ™ˆ';
        _messageColor = Colors.red;
      });

      // é¸å–æ•´å€‹è¼¸å…¥ï¼Œæ–¹ä¾¿é‡æ–°è¼¸å…¥
      _answerController.selection = TextSelection(
        baseOffset: 0,
        extentOffset: _answerController.text.length,
      );
      _requestFocus();
    }
  }

  void _requestFocus() {
    FocusScope.of(context).requestFocus(_answerFocus);
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final bool isTablet = size.shortestSide >= 600;

    return Scaffold(
      appBar: AppBar(
        title: Text(_inSettings ? 'è¨­å®šä½æ•¸' : 'ä¹˜æ³•ç·´ç¿’'),
        centerTitle: true,
        actions: [
          if (!_inSettings)
            IconButton(
              icon: const Icon(Icons.settings),
              tooltip: 'è¨­å®šä½æ•¸',
              onPressed: () {
                setState(() {
                  _inSettings = true;
                });
              },
            ),
        ],
      ),
      body: Center(
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 600),
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: _inSettings
                ? _buildSettingsView(isTablet)
                : _buildPracticeView(isTablet),
          ),
        ),
      ),
    );
  }

  Widget _buildSettingsView(bool isTablet) {
    final double labelFontSize = isTablet ? 24 : 18;
    final double dropdownFontSize = isTablet ? 22 : 16;
    final double buttonFontSize = isTablet ? 24 : 18;

    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        Text(
          'è«‹é¸æ“‡å…©å€‹æ•¸å­—çš„ä½æ•¸',
          style: TextStyle(
            fontSize: isTablet ? 28 : 20,
            fontWeight: FontWeight.bold,
          ),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 32),

        // ç¬¬ä¸€å€‹æ•¸å­—çš„ä½æ•¸
        Text(
          'ç¬¬ä¸€å€‹æ•¸å­—çš„ä½æ•¸',
          style: TextStyle(fontSize: labelFontSize),
        ),
        const SizedBox(height: 8),
        DropdownButtonFormField<int>(
          value: _digitsA,
          items: List.generate(
            9,
            (i) => DropdownMenuItem(
              value: i + 1,
              child: Text('${i + 1} ä½æ•¸'),
            ),
          ),
          onChanged: (value) {
            if (value == null) return;
            setState(() {
              _digitsA = value;
            });
          },
          decoration: const InputDecoration(
            border: OutlineInputBorder(),
          ),
          style: TextStyle(fontSize: dropdownFontSize),
        ),

        const SizedBox(height: 24),

        // ç¬¬äºŒå€‹æ•¸å­—çš„ä½æ•¸
        Text(
          'ç¬¬äºŒå€‹æ•¸å­—çš„ä½æ•¸',
          style: TextStyle(fontSize: labelFontSize),
        ),
        const SizedBox(height: 8),
        DropdownButtonFormField<int>(
          value: _digitsB,
          items: List.generate(
            9,
            (i) => DropdownMenuItem(
              value: i + 1,
              child: Text('${i + 1} ä½æ•¸'),
            ),
          ),
          onChanged: (value) {
            if (value == null) return;
            setState(() {
              _digitsB = value;
            });
          },
          decoration: const InputDecoration(
            border: OutlineInputBorder(),
          ),
          style: TextStyle(fontSize: dropdownFontSize),
        ),

        const SizedBox(height: 32),

        FilledButton(
          onPressed: () {
            _generateNewQuestion();
            setState(() {
              _inSettings = false;
            });
            _requestFocus();
          },
          child: Padding(
            padding: const EdgeInsets.symmetric(vertical: 12.0),
            child: Text(
              'é–‹å§‹ç·´ç¿’',
              style: TextStyle(
                fontSize: buttonFontSize,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPracticeView(bool isTablet) {
    final double questionFontSize = isTablet ? 60 : 36;
    final double inputFontSize = isTablet ? 32 : 24;
    final double buttonFontSize = isTablet ? 26 : 18;

    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        // é¡¯ç¤ºç›®å‰è¨­å®šï¼ˆä¾‹å¦‚ï¼š1 ä½æ•¸ Ã— 3 ä½æ•¸ï¼‰
        Text(
          'ç›®å‰è¨­å®šï¼š${_digitsA} ä½æ•¸ Ã— ${_digitsB} ä½æ•¸',
          style: TextStyle(
            fontSize: isTablet ? 22 : 16,
            color: Colors.grey[700],
          ),
        ),
        const SizedBox(height: 16),

        Text(
          '$_a Ã— $_b = ?',
          style: TextStyle(
            fontSize: questionFontSize,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 32),

        TextField(
          controller: _answerController,
          focusNode: _answerFocus,
          keyboardType: TextInputType.number,
          textAlign: TextAlign.center,
          style: TextStyle(fontSize: inputFontSize),
          decoration: const InputDecoration(
            border: OutlineInputBorder(),
            labelText: 'è«‹è¼¸å…¥ç­”æ¡ˆ',
          ),
          onSubmitted: (_) => _checkAnswer(),
        ),
        const SizedBox(height: 24),

        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            FilledButton(
              onPressed: _checkAnswer,
              child: Text(
                'æª¢æŸ¥ç­”æ¡ˆ',
                style: TextStyle(fontSize: buttonFontSize),
              ),
            ),
            OutlinedButton(
              onPressed: _generateNewQuestion,
              child: Text(
                'æ›ä¸€é¡Œ',
                style: TextStyle(fontSize: buttonFontSize),
              ),
            ),
          ],
        ),

        const SizedBox(height: 24),

        if (_message.isNotEmpty)
          Text(
            _message,
            style: TextStyle(
              fontSize: isTablet ? 24 : 18,
              color: _messageColor,
            ),
            textAlign: TextAlign.center,
          ),
      ],
    );
  }
}

