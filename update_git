#!/bin/bash

# GitHub Pages éƒ¨ç½²è…³æœ¬
# ä½¿ç”¨ git subtree æ–¹å¼éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
# ä½¿ç”¨æ–¹æ³•: ./update_git

set -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ é–‹å§‹éƒ¨ç½²åˆ° GitHub Pages...${NC}"

# æª¢æŸ¥æ˜¯å¦åœ¨æ­£ç¢ºçš„ç›®éŒ„
if [ ! -f "pubspec.yaml" ]; then
    echo -e "${RED}âŒ éŒ¯èª¤: è«‹åœ¨é …ç›®æ ¹ç›®éŒ„åŸ·è¡Œæ­¤è…³æœ¬${NC}"
    exit 1
fi

# æª¢æŸ¥ Flutter æ˜¯å¦å¯ç”¨
if ! command -v flutter &> /dev/null; then
    echo -e "${RED}âŒ éŒ¯èª¤: Flutter æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­${NC}"
    exit 1
fi

# æª¢æŸ¥ git æ˜¯å¦å¯ç”¨
if ! command -v git &> /dev/null; then
    echo -e "${RED}âŒ éŒ¯èª¤: Git æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­${NC}"
    exit 1
fi

# æª¢æŸ¥æ˜¯å¦åœ¨ git å€‰åº«ä¸­
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}âŒ éŒ¯èª¤: ç•¶å‰ç›®éŒ„ä¸æ˜¯ git å€‰åº«${NC}"
    exit 1
fi

# 1. æ¸…ç†ä¸¦ç²å–ä¾è³´
echo -e "${YELLOW}ğŸ§¹ æ¸…ç†èˆŠæ§‹å»º...${NC}"
flutter clean
flutter pub get

# 2. æ§‹å»º Flutter Web æ‡‰ç”¨ï¼ˆä½¿ç”¨ base-href ä»¥æ”¯æ´ GitHub Pagesï¼‰
echo -e "${YELLOW}ğŸ“¦ æ­£åœ¨æ§‹å»º Flutter Web æ‡‰ç”¨...${NC}"
flutter build web --release --base-href /multiplication_practice/ --web-renderer html

# æª¢æŸ¥æ§‹å»ºæ˜¯å¦æˆåŠŸ
if [ ! -d "build/web" ]; then
    echo -e "${RED}âŒ éŒ¯èª¤: æ§‹å»ºå¤±æ•—ï¼Œbuild/web ç›®éŒ„ä¸å­˜åœ¨${NC}"
    exit 1
fi

# 3. ç§»é™¤ service workerï¼ˆé¿å…ç·©å­˜å•é¡Œï¼‰
echo -e "${YELLOW}ğŸ—‘ï¸  ç§»é™¤ service worker...${NC}"
rm -f build/web/flutter_service_worker.js

# 4. æäº¤æºä»£ç¢¼æ›´æ”¹ï¼ˆå¦‚æœæœ‰ï¼‰
echo -e "${YELLOW}ğŸ’¾ æª¢æŸ¥æºä»£ç¢¼æ›´æ”¹...${NC}"
# æª¢æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
    git add .
    if ! git diff --staged --quiet; then
        git commit -m "Update source code - $(date '+%Y-%m-%d %H:%M:%S')"
        git push origin main
        echo -e "${GREEN}âœ… æºä»£ç¢¼å·²æ¨é€${NC}"
    else
        echo -e "${YELLOW}â„¹ï¸  æ²’æœ‰æºä»£ç¢¼æ›´æ”¹éœ€è¦æäº¤${NC}"
    fi
else
    echo -e "${YELLOW}â„¹ï¸  æ²’æœ‰æºä»£ç¢¼æ›´æ”¹${NC}"
fi

# 5. ä½¿ç”¨ git subtree æ¨é€åˆ° gh-pages åˆ†æ”¯
echo -e "${YELLOW}ğŸ“¤ éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯...${NC}"

# æ¸…ç†å¯èƒ½å­˜åœ¨çš„è‡¨æ™‚åˆ†æ”¯
if git show-ref --verify --quiet refs/heads/gh-pages-temp; then
    git branch -D gh-pages-temp 2>/dev/null || true
fi

git add -f build/web
if ! git diff --staged --quiet; then
    git commit -m "Deploy latest version - $(date '+%Y-%m-%d %H:%M:%S')" || true
fi

# ä½¿ç”¨ subtree split æ–¹å¼æ¨é€åˆ° gh-pages
echo -e "${YELLOW}ğŸ“¦ æº–å‚™éƒ¨ç½²æ–‡ä»¶...${NC}"
git subtree split --prefix=build/web -b gh-pages-temp

# æ¨é€ä¸¦æ¸…ç†
echo -e "${YELLOW}â¬†ï¸  æ¨é€åˆ° GitHub...${NC}"
git push origin gh-pages-temp:gh-pages --force
git branch -D gh-pages-temp

echo ""
echo -e "${GREEN}âœ… éƒ¨ç½²å®Œæˆï¼${NC}"
echo -e "${GREEN}ğŸŒ æ‚¨çš„ç¶²ç«™æ‡‰è©²åœ¨å¹¾åˆ†é˜å¾Œåœ¨ä»¥ä¸‹åœ°å€å¯ç”¨ï¼š${NC}"
echo -e "${BLUE}   https://chiamin.github.io/multiplication_practice/${NC}"
echo ""

